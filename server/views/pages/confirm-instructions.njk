{% extends "partials/layout.njk" %}
{%- from "moj/components/sub-navigation/macro.njk" import mojSubNavigation -%}
{% from "govuk/components/breadcrumbs/macro.njk" import govukBreadcrumbs %}
{%- from "govuk/components/fieldset/macro.njk" import govukFieldset -%}
{% from "../components/instructions/macro.njk" import instructions %}
{%- from "govuk/components/input/macro.njk" import govukInput -%}
{%- from "govuk/components/button/macro.njk" import govukButton -%}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}


{% block beforeContent %}
    {{ govukBreadcrumbs({
        items: [
            {
                text: "Home"
            },
            {
                text: "Unallocated cases",
                href: "/"
            },
            {
                text: "Case details",
                href: "/" + crn + "/convictions/" + convictionId + "/case-view"
            },
            {
                text: "Allocate to probation practitioner",
                href: "/" + crn + "/convictions/" + convictionId + "/allocate"
            }
        ]
    }) }}
    {% if errors | length > 0 %}
      {{ govukErrorSummary({
          titleText: "There is a problem",
          errorList: errors
      }) }}
    {% endif %}
{% endblock %}

{% block content %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <h1 class="govuk-heading-xl govuk-!-margin-bottom-2">{{ data.name or name }}
                <span class="govuk-caption-xl">Tier: {{ data.tier or tier }}</span>
                <span class="govuk-caption-xl">CRN: {{ data.crn or crn }}</span>
            </h1>
        </div>
    </div>

    <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">

<div data-module="moj-add-another">
            <div class="govuk-inset-text govuk-!-margin-bottom-7">
                <p>These notes will automatically be sent to <br><strong>{{ data.forename +  ' ' + data.surname }}</strong> (<em>{{ data.email }}</em>)</p>
            </div>
<form action="{{ '/' + crn + '/convictions/' + convictionId + '/allocate/' + staffCode + '/confirm-allocation' }}" method="POST">
    <input type="hidden" name="_csrf" value="{{ csrfToken }}">
    {{
    instructions({
        titleText: "Review allocation instructions",
        hintText: "Review your notes for the probation practitioner.",
        convictionId: convictionId
    })
    }}



    <p id='copyText'>You can send a copy of these notes to another recipient, for example a case admin officer.</p>
 {% if confirmInstructionForm.person.length === 0 %}
{% call govukFieldset({
      classes: 'moj-add-another__item',
      legend: {
        text: 'Add a recipient',
        classes: 'moj-add-another__title govuk-fieldset__legend--m',
        isPageHeading: false
      }
    }) %}
    
    {{ govukInput({
      id: 'person[0][email]',
      name: 'person[0][email]',
      label: {
        text: 'Email address',
        classes: 'govuk-!-font-weight-bold'
      },
      type: "email",
      autocomplete: "email",
      spellcheck: false,
      attributes: {
        'data-name': 'person[%index%][email]',
        'data-id': 'person[%index%][email]'
      }
    }) }}

    {% endcall %}
    {% endif %}

    {% for person in confirmInstructionForm.person %}

    {% call govukFieldset({
      classes: 'moj-add-another__item',
      legend: {
        text: 'Add a recipient',
        classes: 'moj-add-another__title govuk-fieldset__legend--m',
        isPageHeading: false
      }
    }) %}

    {% if confirmInstructionForm.person.length > 1 %}
      <button type="button" class="govuk-button govuk-button--secondary moj-add-another__remove-button">Remove</button>
    {% endif %}
    
    {{ govukInput({
      id: 'person[' +loop.index0 +'][email]',
      name: 'person[' +loop.index0 +'][email]',
      label: {
        text: 'Email address',
        classes: 'govuk-!-font-weight-bold'
      },
      type: "email",
      autocomplete: "email",
      spellcheck: false,
      value: person.email,
      errorMessage: errors | findError('person[' +loop.index0 +'][email]'),
      attributes: {
        'data-name': 'person[%index%][email]',
        'data-id': 'person[%index%][email]'
      }
    }) }}

    {% endcall %}

    {% endfor %}

<div class="moj-button-action">
      {{ govukButton({
        text: 'Add another person',
        name: 'action',
        value: 'add-another-person',
        classes: 'govuk-button--secondary moj-add-another__add-button govuk-!-margin-bottom-4'
      }) }}
    </div>


    <div class="govuk-button-group">
        {{
            govukButton({
                text: 'Continue',
                classes: 'allocate',
                type: 'submit',
                name: 'action',
                value: 'continue',
                preventDoubleClick: true,
                attributes: {
                    id: convictionId
                }
            })
        }}
        <a class="govuk-link" href="{{ '/' + crn + '/convictions/' + convictionId + '/allocate' }}">Cancel</a>
    </div>
</form>
</div>

{% endblock %}

