{% extends "partials/case-view.njk" %}
{% from "govuk/components/tabs/macro.njk" import govukTabs %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "../components/index-card/macro.njk" import indexCard %}

{% set pageTitle = applicationName + " - Risk" %}

{% set activeRegistrationsData = {
    classes: 'active-registrations-table',
    caption: 'Active registrations',
    captionClasses: 'govuk-table__caption--m',
    head: [
        { text: 'Type'},
        { text: 'Registered'},
        { text: 'Next review'},
        { text: 'Notes'}
    ],
    rows: []
} %}

{% for registration in data.activeRegistrations %}
    {{
    activeRegistrationsData.rows.push([
        { text: registration.type },
        { text: registration.registered | dateFormat },
        { text: registration.nextReviewDate | dateFormat },
        { text: registration.notes if registration.notes | length else '-'}
    ])
    }}
{% endfor %}

{% set inactiveRegistrationsData = {
    classes: 'inactive-registrations-table',
    caption: 'Inactive registrations',
    captionClasses: 'govuk-table__caption--m',
    head: [
        { text: 'Type'},
        { text: 'Registered'},
        { text: 'End date'},
        { text: 'Notes'}
    ],
    rows: []
} %}

{% for registration in data.inactiveRegistrations %}
    {{
    inactiveRegistrationsData.rows.push([
        { text: registration.type },
        { text: registration.registered | dateFormat},
        { text: registration.endDate | dateFormat},
        { text: registration.notes if registration.notes | length else '-'}
    ])
    }}
{% endfor %}


{% block caseContent %}

    <h2 class="govuk-heading-l">Risk</h2>

    <h3 class="govuk-heading-m">Assessment tools</h3>

    {{
        indexCard({
            titleHtml: '<div class="tooltip">ROSH<span class="tooltiptext govuk-body-s">Risk of Serious Harm</span></div>',
            descriptionText: ('Last updated: ' + data.rosh.lastUpdatedOn | dateFormat),
            tagText: data.rosh.level
        })
    }}

    {{
        indexCard({
            titleHtml: ('<div class="tooltip">RSR<span class="tooltiptext govuk-body-s">Risk of Serious Recidivism</span></div><span>' + data.rsr.percentage + '%</span>'),
            descriptionText: ('Last updated: ' + data.rsr.lastUpdatedOn | dateFormat),
            tagText: data.rsr.level
        })
    }}

    {{
        indexCard({
            titleHtml: ('<div class="tooltip">OGRS<span class="tooltiptext govuk-body-s">Offender Group Reconviction Scale</span></div><span>' + data.ogrs.score + '%</span>')
        })
    }}

    <h3 class="govuk-heading-m">Register</h3>

    {{ govukTabs({
        items: [
            {
                label: "Active registrations (" + (data.activeRegistrations | length) + ")",
                id: "active-registrations",
                panel: {
                html: (govukTable(activeRegistrationsData) if data.activeRegistrations | length > 0 else '<div class="govuk-body">There are no active registrations.</div>')
            }
            },
            {
                label: "Inactive registrations (" + (data.inactiveRegistrations | length) + ")",
                id: "inactive-registrations",
                panel: {
                html: (govukTable(inactiveRegistrationsData) if data.inactiveRegistrations | length > 0 else '<div class="govuk-body">There are no inactive registrations.</div>')
            }
            }
        ]
    }) }}


{% endblock %}
